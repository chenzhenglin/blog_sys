
{{extend './_layout/layout.html'}}
{{block 'title'}}{{ 我的 }}{{/block}}
{{block 'css'}}
<link href="/public/css/my_common.css" rel="stylesheet">
<link href="/public/css/my_profile.css" rel="stylesheet">
{{/block}}
{{block 'content'}}
{{include './_partial/header.html'}}
<!-- Begin page content -->
<main role="main" class="container">
    <div class="row">
        <div>
            {{include './_partial/profile_basic.html'}}
        </div>
        <div class="col-container col">
            <section class="info-sec">
                <h3 class="title" style="float: left">个人资料</h3>
                <div class="info-left avatar-modal modifier-info">
                    <p>
                        <img width="100" height="100" src="../public/img/avatar-default.png" alt="../public/img/avatar-default.png" class="avatar rounded-circle">
                        <div class="modifier-info p-avatar">
                            <div>修改头像</div>
                        </div>
                    </p>

                </div>
                <div class="info-right">
                    <div style="font-size: 14px">
                        <div style="padding-bottom: 0px;margin-bottom: 5px;">
                            <span style="color: #A599A5;">ID：zhangsan</span>
                            <span style="float: right"><a href="/my/main">个人主页 ></a></span>
                        </div>
                        <div style="border-bottom: 1px solid #E0E0E0;padding-bottom: 8px;">
                            <span>关注  1</span>
                            <span style="padding-left: 30px">粉丝  0</span>
                        </div>
                        <ul style="margin-top: 5px">
                            <li class="info-li-item">昵称：<span class="modifier-info info-modal" style="float: right">修改资料</span></li>
                            <li class="info-li-item">实名：</li>
                            <li class="info-li-item">性别：</li>
                            <li class="info-li-item">年龄：</li>
                            <li class="info-li-item">地区：</li>
                            <li class="info-li-item">行业：</li>
                            <li class="info-li-item">职位：</li>
                            <li class="info-li-item">简介：</li>
                        </ul>
                    </div>
                </div>
            </section>
        </div>
    </div>
</main>
<div class="modal fade bd-example-modal-lg" id="avatarModal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">上传头像</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="img-drag" style="display: block">
                    <div id="file-upload">
                        <input type="file" style="display: none" id="upload-avatar" accept=".jpg,.jpeg,.png">
                    </div>
                    <div class="file-area">
                        <div style="position: relative;top: 30%;font-size: 3rem" class="icon-folder-upload">

                        </div>
                        <span>点击或拖拽图片至此</span>
                    </div>
                    <span style="font-size: 10px;color: #5c5c5c">
                        <i style="color: red;font-size: 12px">*</i>&nbsp;&nbsp;图片宽高大于100*100，图片大小2M以下
                    </span>
                </div>

                <div class="img-review" style="display: none;text-align: center">
                    <!--<span style="text-align: center;margin-right: 50px"><img src="" width="200" height="200" alt="原图" class="review-srq img-thumbnail"></span>-->
                    <span style="text-align: center"><img src="" width="100" height="100" alt="头像" class="review-circle rounded-circle"></span>
                    <div class="progress-div">
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">25%</div>
                        </div>
                    </div>
                </div>

            </div>
            <div id="modify-modal-footer" class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="infoModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">修改资料</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="modifier-form" method="post" action="/my/modify">
                    <div class="form-group row">
                        <label for="nickname" class="col-sm-2 col-form-label">昵称：</label>
                        <div class="col-sm-10">
                            <input type="text" name="nickname" class="form-control" id="nickname">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="name" class="col-sm-2 col-form-label">实名：</label>
                        <div class="col-sm-10">
                            <input type="text" name="name" class="form-control" id="name">
                        </div>
                    </div>
                    <div class="form-group row">
                        <legend class="col-form-label col-sm-2">性别：</legend>
                        <div class="col-sm-10">
                            <select name="sex" class="custom-select mr-sm-2" id="select-sex">
                                <option selected>请选择</option>
                                <option value="1">男</option>
                                <option value="2">女</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group row">
                        <label for="age" class="col-sm-2 col-form-label">年龄：</label>
                        <div class="col-sm-10">
                            <input type="text" name="age" class="form-control" id="age">
                        </div>
                    </div>

                    <div class="form-group row">
                        <label for="area" class="col-sm-2 col-form-label">地区：</label>
                        <div class="col-sm-10">
                            <input type="text" name="area" class="form-control" id="area">
                        </div>
                    </div>

                    <div class="form-group row">
                        <legend class="col-form-label col-sm-2">行业：</legend>
                        <div class="col-sm-10">
                            <select class="custom-select mr-sm-2" name="work" id="work">
                                <option selected>请选择</option>
                                <option value="1">电子</option>
                                <option value="2">计算机</option>
                                <option value="3">金融</option>
                                <option value="4">建筑</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group row">
                        <label for="position" class="col-sm-2 col-form-label">职位：</label>
                        <div class="col-sm-10">
                            <input type="text" name="position" class="form-control" id="position">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="introduce" class="col-sm-2 col-form-label">简介：</label>
                        <div class="col-sm-10">
                            <textarea class="form-control" name="introduce" placeholder="300字以内" id="introduce" rows="3"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" id="btn-submit" class="btn btn-danger">确定</button>
            </div>
        </div>
    </div>
</div>
{{/block}}
{{block 'script'}}
<script>

    /**
     *修改个人资料界面对象
     */
    var modify = {
        init : function () {
            this.addEvent();
        },
        addEvent : function () {
            $(".info-modal").click(function () {
                $('#infoModal').modal('show');
            });

            $("#btn-submit").click(function () {
                // 提前校验数据

                $.ajax({
                    url:"/my/modify",//提交地址
                    data:$("#modifier-form").serialize(),//将表单数据序列化
                    type:"POST",
                    dataType:"json",
                    success:function(result){
                        if (result.success){
                            alert("成功！");
                        }else{
                            alert("失败！");
                        }
                    }
                });
            });
        }
    };

    /**
     *修改头像界面对象
     */
    var avatar = {
        avatarTem : null,//临时头像存储
        init : function () {
            this.addEvent();
        },
        addEvent : function () {
            /*模态窗点击事件监听*/
            $(".avatar-modal").click(function () {
                $('#avatarModal').modal('show');
            });

            $(".file-area").click(function () {
                // 打开文件夹
                $("#upload-avatar").click();
            });

            $(".file-area")[0].addEventListener("drop", _dropCallback, false);

            $(".file-area").on('dragover',function (ev) {
                console.log("dragover");
                ev.preventDefault();

            }).on('dragenter', function (ev) {
                console.log("dragenter");
                console.log(ev);
                ev.preventDefault();

            }).on('dragleave', function (ev) {
                console.log("dragleave");
                ev.preventDefault();

            });

            $('#avatarModal').on('hidden.bs.modal', function (e) {
                $(".btn-img-submit").off("click");
                $("#modify-modal-footer").html('<button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>');
                $(".img-drag").show();
                $(".img-review").hide();
                $(".modal-title").text("上传头像");
            });

            function _dropCallback(ev) {
                if(1 === ev.dataTransfer.files.length){
                    if(avatar.checkImgType(ev.dataTransfer.files[0])){
                        //avatar.upload(ev.dataTransfer.files[0]);
                        avatar.review(ev.dataTransfer.files[0]);
                    } else {
                        alert("请输入图片类型文件");
                    }
                } else {
                    alert("只能传一张。");
                }
                ev.preventDefault();
            }

            // input file 注册change事件
            $("#upload-avatar").on("change",_onchange);

            function _onchange(ev) {
                console.log($(this)[0].files);
                $("#upload-avatar")
                    .replaceWith('<input type="file" style="display: none" id="upload-avatar" accept=".jpg,.jpeg,.png">');
                $("#upload-avatar").off('change').on('change', _onchange);// reset input file

                if (1 === $(this)[0].files.length){
                    var file = $(this)[0].files[0];
                    if(file.size > 1024 * 1024 * 2) {
                        alert('图片大小不能超过 2MB!');
                        return false;
                    } else if(avatar.checkImgType(file)) {
                        /*预览*/
                        avatar.review(file);
                    } else {
                        alert("请输入图片类型文件");
                    }
                } else {
                    alert("只能传一张。");
                }

                ev.preventDefault();
                return false;
            }

        },
        upload : function (file) {
            var fromData=new FormData(file);

            fromData.append("user_avatar", file);

            $.ajax({
                url : '/my/avatar',
                type : 'POST',
                data : fromData,
                contentType : false,
                processData : false,// 文件表单提交时必须设置为false
                xhr : _bindOnProgress(function (ev){
                    var _width = Math.floor(100*ev.loaded/ev.total);
                    /*显示进度条*/
                    $(".progress-div").show();
                    /*改变进度条*/
                    $('.progress-bar')
                        .css("width", _width+"%")
                        .html(_width+"%");
                }),
                success : function (data_) {
                    $('.avatar').attr("src", avatar.avatarTem);
                    setTimeout(function () {
                        $('#avatarModal').modal('hide');
                    }, 1500);
                },
                error : function (err_) {
                    alert("上传失败")
                }
            })

            function _bindOnProgress(fn) {

                return function () {
                    var xhr = $.ajaxSettings.xhr();

                    if(typeof fn !== 'function') return xhr;

                    if(fn && xhr.upload) xhr.upload.addEventListener("progress", fn, false);

                    return xhr;
                }
            }

            return;


            /*var oAjax=new XMLHttpRequest();

            //POST
            oAjax.open('POST', '/my/avatar', true);

            //进度条
            oAjax.upload.addEventListener('progress', function (ev){
                console.log(ev.loaded);
                console.log(ev.total);
                var _width = Math.floor(100*ev.loaded/ev.total);
                $(".progress-div").show();
                $('.progress-bar')
                    .css("width", _width+"%")
                    .html(_width+"%");
            }, false);

            oAjax.send(fromData);

            oAjax.onreadystatechange=function (){
                if(oAjax.readyState==4){
                    if(oAjax.status>=200 && oAjax.status<300 || oAjax.status==304){
                        $('.avatar').attr("src", avatar.avatarTem);
                        setTimeout(function () {
                            $('#avatarModal').modal('hide');
                        }, 1500);
                    }else{
                        alert('上传失败');
                    }
                }
            };*/
        },
        checkImgType : function (file) {
            if(-1 < file.type.indexOf("image/")) {
                return true;
            }
            else {
                return false;
            }
        },
        review : function (file) {
            // 隐藏进度条
            $(".progress-div").hide();
            //avatar.upload($(this)[0].files[0]);
            var reader = new FileReader();
            reader.onload = function (ev) {
                $(".img-drag").hide();
                $(".img-review").show();
                $(".modal-title").text("预览头像");
                $(".btn-prev").off("click");
                $("#modify-modal-footer").html('<button type="button" class="btn btn-secondary btn-prev">重新上传</button>' +
                    '<button type="button" class="btn btn-danger btn-img-submit">上传并使用</button>');
                /*$(".review-srq").attr('src',this.result);*/
                avatar.avatarTem = this.result;
                $(".review-circle").attr('src', avatar.avatarTem);

                $(".btn-prev").on("click",function (ev) {
                    $(".btn-img-submit").off("click");
                    $("#modify-modal-footer").html('<button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>');
                    $(".img-drag").show();
                    $(".img-review").hide();
                    $(".modal-title").text("上传头像");
                });
                ev.srcElement.value = "";
                $(".btn-img-submit").on("click",function (ev) {
                    avatar.upload(file);
                });
            };

            reader.readAsDataURL(file);
        }
    };

    (function () {
        $(function () {
            modify.init();
            avatar.init();
        });
    })()

</script>

{{/block}}
